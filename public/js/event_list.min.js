var curDotorId=USERID;var isPatient=USERROLE=="3"?true:false;var curEventId;var viewDiagnoseDialog=$("#view-diagnose");var eventListTable=$("#eventListTable");eventListTable.on("click","[data-target=#view-diagnose]",function(a){var d=$(this).closest("tr");curEventId=d.data("eventid");var e=d.data("event");var c=d.data("happentime");var b=d.data("isview");var g=d.data("patientname");var f=d.data("sex");var i=d.data("age");var h=[e,c,b,g,f,i];viewDiagnoseDialog.find("tbody tr td").each(function(k){$(this).text(h[k])});viewDiagnoseDialog.find("[name=patient_id]").val(d.data("uid")).end().find("[name=patient_name]").val(d.data("patientname"));$.get("/get_related_diagnose?eid="+curEventId,function(p){console.log(p);var o="";var n='<button type="button" class="btn btn-warning btn-xs modify-btn">编辑</button>';var r=isPatient?"":"<td>"+n+"</td>";for(var m=0,k=p.length;m<k;m++){var l=p[m];var q=(curDotorId==l.doctor_id?n:"");o+='<tr data-diagnoseid="'+l._id+'">'+"<td>"+moment(l.create_time).format("YYYY-MM-DD HH:mm")+"</td>"+"<td>"+l.doctor_name+"</td>"+'<td class="dia-content">'+"<p>"+l.content+"</p>"+"</td>"+r+"</tr>"}$("#diagnose-list").find("tbody").html(o)});var j=d.find("[data-isview]");if(USERROLE==2&&j.data("isview")!=true){$.post("/set_event_view",{eventId:curEventId},function(k){if(k.status===true){j.data("isview",true).text("已查看")}})}});var ecgDialog=$("#ecg-dialog");eventListTable.on("click",".ecg-btn",function(d){d.preventDefault();var e=$(this).closest("tr");var a=$(this).data("img");var b=e.data("type")=="0";var c=b?"black_bg":"";ecgDialog.find(".modal-body").html("<img class='"+c+"' src='"+a+"'>")});var diagnoseBtn=$(".diagnose-btn"),diagnoseContainer=$(".diagnose-container"),diagnoseOl=diagnoseContainer.find("ol");var diagnoseForm=$("#diagnose-form");diagnoseBtn.on("click",function(a){diagnoseForm.fadeToggle()});diagnoseForm.submit(function(a){a.preventDefault();var c=$("[name=diagnose_content]").val().trim();var b=$(this).attr("action")+curEventId;$.post(b,$(this).serialize(),function(d){console.log("添加诊断记录成功");$("[name=diagnose_content]").val("");diagnoseForm.fadeToggle();console.log(d);$('<tr data-diagnoseid="'+d._id+'">'+"<td>"+d.create_time+"</td>"+"<td>"+d.doctor_name+"</td>"+'<td class="dia-content">'+"<p>"+d.content+"</p>"+"</td>"+'<td><button type="button" class="btn btn-warning btn-xs modify-btn">编辑</button></td>'+"</tr>").prependTo($("#diagnose-list").find("tbody"))})});diagnoseForm.on("click",".cancel-btn",function(a){a.preventDefault();diagnoseForm.fadeToggle()});var viewDiagnose=$("#view-diagnose");var initVal;if(USERROLE==2){viewDiagnose.on("click",".modify-btn",function(c){var b=$(this).closest("tr");var d=b.find(".dia-content");if($(this).text()=="编辑"){initVal=d.find("p").text().trim();d.find("p").replaceWith("<textarea class='form-control'>"+initVal+"</textarea>");$(this).text("保存")}else{var a=d.find("textarea").val().trim();d.find("textarea").replaceWith("<p>"+a+"</p>");if(a!==initVal){$.post("/modify_diagnose?did="+b.data("diagnoseid"),{content:a},function(e){})}$(this).text("编辑")}})}var searchForm=$("#search-form");var eventList=$("#eventListTable").find("tbody");searchForm.submit(function(a){a.preventDefault();$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(f){console.log(f);eventList.empty();var g="";for(var e=0,b=f.eventList.length;e<b;e++){var d=f.eventList[e];var c=moment(d.happen_time).format("YYYY年MM月DD日 HH:MM:SS");g+='<tr data-uid="'+d.user._id+'" data-eventid="'+d._id+'" data-event-level="'+d.level+'" data-event="'+d.name+'" data-happentime="'+c+'" data-isview="'+(d.is_view?"已查看":"未查看")+'" data-patientname="'+d.user.role_prop.real_name+'" data-sex="'+(d.user.role_prop.sex==0?"男":"女")+'" data-age="'+d.user.role_prop.age+'" data-type="'+d.type+'">'+"<td>"+d.name+"</td>"+"<td>"+c+"</td>"+"<td>"+d.user.role_prop.real_name+"</td>"+'<td data-sex="'+d.user.role_prop.sex+'">'+(d.user.role_prop.sex==0?"男":"女")+"</td>"+"<td>"+d.user.role_prop.age+"</td>"+'<td data-isview="'+d.is_view+'">'+(d.is_view?"已查看":"未查看")+"</td>"+'<td><a href="javascript:;" data-img="'+d.img+'" data-toggle="modal" data-target="#ecg-dialog" class="ecg-btn">查看具体信息</a></td>'+"<td>"+'<button type="button" data-toggle="modal" data-target="#view-diagnose" class="btn btn-success btn-sm">查看详情</button>'+"</td>"+"</tr>"}eventList.html(g)}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});
