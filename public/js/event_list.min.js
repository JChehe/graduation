var curEventId,ecgDialog,diagnoseBtn,diagnoseContainer,diagnoseOl,diagnoseForm,viewDiagnose,initVal,searchForm,eventList,curDotorId="#{user._id}",isPatient=!1,viewDiagnoseDialog=$("#view-diagnose"),eventListTable=$("#eventListTable");eventListTable.on("click","[data-target=#view-diagnose]",function(){var c,d,e,f,g,h,i,j,b=$(this).closest("tr");curEventId=b.data("eventid"),c=b.data("event"),d=b.data("happentime"),e=b.data("isview"),f=b.data("patientname"),g=b.data("sex"),h=b.data("age"),i=[c,d,e,f,g,h],viewDiagnoseDialog.find("tbody tr td").each(function(a){$(this).text(i[a])}),viewDiagnoseDialog.find("[name=patient_id]").val(b.data("uid")).end().find("[name=patient_name]").val(b.data("patientname")),$.get("/get_related_diagnose?eid="+curEventId,function(a){var b,c,d,e,f,g;for(console.log(a),b="",c='<button type="button" class="btn btn-warning btn-xs modify-btn">编辑</button>',d=isPatient?"":"<td>"+c+"</td>",e=0,f=a.length;f>e;e++)g=a[e],curDotorId==g.doctor_id?c:"",b+='<tr data-diagnoseid="'+g._id+'">'+"<td>"+moment(g.create_time).format("YYYY-MM-DD HH:mm")+"</td>"+"<td>"+g.doctor_name+"</td>"+'<td class="dia-content">'+"<p>"+g.content+"</p>"+"</td>"+d+"</tr>";$("#diagnose-list").find("tbody").html(b)}),j=b.find("[data-isview]"),2==USERROLE&&1!=j.data("isview")&&$.post("/set_event_view",{eventId:curEventId},function(a){a.status===!0&&j.data("isview",!0).text("已查看")})}),ecgDialog=$("#ecg-dialog"),eventListTable.on("click",".ecg-btn",function(a){a.preventDefault(),$(this).closest("tr");var c=$(this).data("img");ecgDialog.find(".modal-body").html("<img src='"+c+"'>")}),diagnoseBtn=$(".diagnose-btn"),diagnoseContainer=$(".diagnose-container"),diagnoseOl=diagnoseContainer.find("ol"),diagnoseForm=$("#diagnose-form"),diagnoseBtn.on("click",function(){diagnoseForm.fadeToggle()}),diagnoseForm.submit(function(a){a.preventDefault(),$("[name=diagnose_content]").val().trim();var c=$(this).attr("action")+curEventId;$.post(c,$(this).serialize(),function(a){console.log("添加诊断记录成功"),$("[name=diagnose_content]").val(""),diagnoseForm.fadeToggle(),console.log(a),$('<tr data-diagnoseid="'+a._id+'">'+"<td>"+a.create_time+"</td>"+"<td>"+a.doctor_name+"</td>"+'<td class="dia-content">'+"<p>"+a.content+"</p>"+"</td>"+'<td><button type="button" class="btn btn-warning btn-xs modify-btn">编辑</button></td>'+"</tr>").prependTo($("#diagnose-list").find("tbody"))})}),diagnoseForm.on("click",".cancel-btn",function(a){a.preventDefault(),diagnoseForm.fadeToggle()}),viewDiagnose=$("#view-diagnose"),viewDiagnose.on("click",".modify-btn",function(){var d,b=$(this).closest("tr"),c=b.find(".dia-content");"编辑"==$(this).text()?(initVal=c.find("p").text().trim(),c.find("p").replaceWith("<textarea class='form-control'>"+initVal+"</textarea>"),$(this).text("保存")):(d=c.find("textarea").val().trim(),c.find("textarea").replaceWith("<p>"+d+"</p>"),d!==initVal&&$.post("/modify_diagnose?did="+b.data("diagnoseid"),{content:d},function(){}),$(this).text("编辑"))}),searchForm=$("#search-form"),eventList=$("#eventListTable").find("tbody"),searchForm.submit(function(a){a.preventDefault(),$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(b){var c,d,e,f,g;for(console.log(b),eventList.empty(),c="",d=0,e=b.eventList.length;e>d;d++)f=b.eventList[d],g=moment(f.happen_time).format("YYYY年MM月DD日 HH:MM:SS"),c+='<tr data-uid="'+f.user._id+'" data-eventid="'+f._id+'" data-event-level="'+f.level+'" data-event="'+f.name+'" data-happentime="'+g+'" data-isview="'+(a.is_view?"已查看":"未查看")+'" data-patientname="'+f.user.role_prop.real_name+'" data-sex="'+(0==f.user.role_prop.sex?"男":"女")+'" data-age="'+f.user.role_prop.age+'">'+"<td>"+f.name+"</td>"+"<td>"+g+"</td>"+"<td>"+f.user.role_prop.real_name+"</td>"+'<td data-sex="'+f.user.role_prop.sex+'">'+(0==f.user.role_prop.sex?"男":"女")+"</td>"+"<td>"+f.user.role_prop.age+"</td>"+'<td data-isview="'+f.is_view+'">'+(f.is_view?"已查看":"未查看")+"</td>"+'<td><a href="javascript:;" data-img="'+f.img+'" data-toggle="modal" data-target="#ecg-dialog" class="ecg-btn">查看具体信息</a></td>'+"<td>"+'<button type="button" data-toggle="modal" data-target="#view-diagnose" class="btn btn-success btn-sm">查看详情</button>'+"</td>"+"</tr>";eventList.html(c)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})});