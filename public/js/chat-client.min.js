$(function(){var j=10;var b=3500;var q=$("#chat-container");var k=q.find("form");var s=q.find("textarea");var n=q.find(":submit");var f=q.find(".content-list");var e=$("#talk-people");var d=e.find("button:first");var t=e.find(".dropdown-menu");var a=$("[name=talk_people_id]");var h=$(".get-history-btn");var g=Date.now();var r=[];var m=[];q.on("click",".nav",function(v){v.preventDefault();q.toggleClass("active");if(q.hasClass("active")){u.boot(r)}else{console.log(r);u.stop()}});k.submit(function(v){v.preventDefault();var w=s.val().trim();$.post("/save_chat_record",{talk_people_id:a.val(),message:w},function(y){if(y.status==true){console.log(y.chatRecord._id);m.push(y.chatRecord._id);var x=c(y.chatRecord,f.children("div.active").data("id"),true);o(x,f.children("div.active").data("id"),true);s.val("")}}).fail(function(){alert("发送失败")})});$.get("/get_talk_people",function(z){if(z.status==true){var y="";var A="";for(var x=0,v=z.userList.length;x<v;x++){var w=z.userList[x];y+="<li data-user-id='"+w._id+"'><a href='javascript:;'>"+w.role_prop.real_name+"</a></li>";A+="<div id="+w._id+" data-id="+w._id+" data-name="+w.role_prop.real_name+" class='user-chat-content' data-last-msg-timestamp="+0+"><div class='get-history-btn'>点击获取最近与"+w.role_prop.real_name+"的"+j+"条信息</div></div>"}t.html(y);f.html(A);f.children("div").each(function(C){var B=$(this).attr("id");r.push(B)})}});var u=(function(){var y=false;var w={};function x(A,B){if(!y){B=B||0;for(var D=0,z=A.length;D<z;D++){(function(E){w[E]=setInterval(function(){C(E)},b);C(E)})(A[D])}y=true}function C(E){var F=Date.now();console.log($("#"+E).find(".pollMsg:last").data("timestamp"));if(USERROLE=="2"){$.ajax("/get_chat_record?belong="+3+"&patient_id="+E+"&doctor_id="+USERID+"&limit="+B+"&timestamp="+($("#"+E).find(".pollMsg:last").data("timestamp")||g)+"&random="+F).done(function(G){i(G,E)}).fail()}else{if(USERROLE=="3"){$.ajax("/get_chat_record?belong="+2+"&patient_id="+USERID+"&doctor_id="+E+"&limit="+B+"&timestamp="+($("#"+E).find(".pollMsg:last").data("timestamp")||g)+"&random="+F).done(function(G){i(G,E)}).fail()}}}}function v(){for(var z in w){console.log(z);if(w.hasOwnProperty(z)){clearInterval(w[z])}}y=false}return{boot:x,stop:v}})();function i(y,x){var A=c(y.chatRecordList,x,true);var w=$(A);var z=$("#"+x).find(".new");if(z.length===0){$("#"+x).append(w)}else{w.each(function(C){$(this).addClass("pollMsg");var B=$(this).data("mid");if(m.indexOf(B)!==-1){return true}m.push(B);v($(this),z)})}function v(F,E){var D=parseInt(F.data("timestamp"),10);for(var C=0,B=E.length;C<B;C++){if(parseInt(E.eq(C).data("timestamp"))>D){F.insertBefore(E.eq(C));break}}if(C===E.length){F.insertAfter(E.last())}}}f.on("click",".get-history-btn",function(y){y.preventDefault();var x=$(this).parent();var w=x.attr("id");var v=$(this);p(w).done(function(z){console.log("获取最近10条信息");var A=c(z.chatRecordList,w,false);o(A,x.data("id"),false);if(z.chatRecordList.length<j){v.text("你与"+x.data("name")+"聊天记录已全部加载");v.delay(2500).fadeOut("400",function(){})}}).fail(function(){console.log("err")})});t.on("click","li",function(w){w.preventDefault();var v=$(this).data("userId").trim();if(v.length===0){n.prop("disabled",true)}else{n.prop("disabled",false)}a.val($(this).data("userId"));d.text($(this).text());f.find("#"+v).siblings("div").removeClass("active").end().addClass("active")});n.prop("disabled",true).attr("title","请选选择交流对象");function c(y,E,F){var z=$("#"+E);var w="";if(y==undefined){console.log("无数据");return}if(!(y.hasOwnProperty("length"))){y=[y]}for(var A=0,C=y.length;A<C;A++){var x=y[A];var D=l(x)?"me":"other";var B=x.belong=="2"?x.doctor_id:x.patient_id;var v=D==="me"?"我：":("："+z.data("name"));if(A===C-1&&!F){D+=" last-history"}if(F){D+=" new"}w+='<div class="msg '+D+'" data-user-id="'+B+'" data-mid="'+x._id+'"  data-timestamp='+Date.parse(x.create_at)+'><span class="user-name">'+v+'</span><div class="msg-content"><p class="time">'+moment(x.create_at).format("YYYY-MM-DD HH:mm:ss")+"</p><p>"+x.content+"</p></div></div>";if(A===C-1&&!F){$("#"+z.data("id")).data("last-msg-timestamp",Date.parse(x.create_at))}}return w}function l(w){var v;switch(USERROLE){case"2":v="doctor_id";break;case"3":v="patient_id";break}if(w.belong==USERROLE&&w[v]==USERID){return true}else{return false}}function p(x,w){w=w||j;var v=a.val();var y=Date.now();if(USERROLE=="2"){return $.ajax("/get_chat_record?&patient_id="+v+"&doctor_id="+USERID+"&limit="+j+"&timestamp="+$("#"+x).data("last-msg-timestamp")+"&firstloadtimestamp="+g)}else{if(USERROLE=="3"){return $.ajax("/get_chat_record?&patient_id="+USERID+"&doctor_id="+v+"&limit="+j+"&timestamp="+$("#"+x).data("last-msg-timestamp")+"&firstloadtimestamp="+g)}}}function o(A,x,y){if(y==undefined){y=true}var z=$("#"+x);if(y){z.append(A)}else{var w=z.find(".last-history:last");if(w.length===0){var v=z.find(".new");if(v.length>0){v.first().before(A)}else{z.append(A)}}else{w.after(A)}}}});
