$(function(){var j=10;var b=3500;var q=$("#chat-container");var k=q.find("form");var t=q.find("textarea");var n=q.find(":submit");var f=q.find(".content-list");var e=$("#talk-people");var d=e.find("button:first");var v=e.find(".dropdown-menu");var a=$("[name=talk_people_id]");var h=$(".get-history-btn");var g=Date.now();var s=[];var m=[];var x=[];q.on("click",".nav",function(y){y.preventDefault();q.toggleClass("active");if(q.hasClass("active")){w.boot(s)}else{console.log(s);w.stop()}});k.submit(function(y){y.preventDefault();var z=t.val().trim();if(z.length===0){alert("还没有输入聊天内容哦");return}$.post("/save_chat_record",{talk_people_id:a.val(),message:z},function(B){if(B.status==true){console.log(B.chatRecord._id);m.push(B.chatRecord._id);var A=c(B.chatRecord,f.children("div.active").data("id"),true);o(A,f.children("div.active").data("id"),true);t.val("")}}).fail(function(){alert("发送失败")})});$.get("/get_talk_people",function(C){if(C.status==true){var B="";var D="";for(var A=0,y=C.userList.length;A<y;A++){var z=C.userList[A];B+="<li data-user-id='"+z._id+"'><a href='javascript:;'>"+z.role_prop.real_name+"</a></li>";D+="<div id="+z._id+" data-id="+z._id+" data-name="+z.role_prop.real_name+" class='user-chat-content' data-last-msg-timestamp="+Date.now()+"><div class='get-history-btn'>点击获取最近与"+z.role_prop.real_name+"的"+j+"条信息</div></div>"}v.html(B);f.html(D);f.children("div").each(function(F){var E=$(this).attr("id");s.push(E)})}});var w=(function(){var B=false;var z={};function A(D,E){if(!B){E=E||0;for(var G=0,C=D.length;G<C;G++){(function(H){z[H]=setInterval(function(){F(H)},b);F(H)})(D[G])}B=true}function F(H){var I=Date.now();var J=g;if(x.length!==0){J=u(x)}if(USERROLE=="2"){$.ajax("/get_poll_record?belong="+3+"&patient_id="+H+"&doctor_id="+USERID+"&limit="+E+"&timestamp="+J+"&random="+I).done(function(K){i(K,H)}).fail()}else{if(USERROLE=="3"){$.ajax("/get_poll_record?belong="+2+"&patient_id="+USERID+"&doctor_id="+H+"&limit="+E+"&timestamp="+J+"&random="+I).done(function(K){i(K,H)}).fail()}}}}function y(){for(var C in z){console.log(C);if(z.hasOwnProperty(C)){clearInterval(z[C])}}B=false}return{boot:A,stop:y}})();function i(A,G){if(A.chatRecordList.length===0){return}for(var B=0,D=A.chatRecordList.length;B<D;B++){var y=Date.parse(A.chatRecordList[B].create_at);if(x.indexOf(y)===-1){x.push(y)}}var E=c(A.chatRecordList,G,true);var z=$(E);var C=$("#"+G).find(".new");z.each(function(I){$(this).addClass("pollMsg")});for(var B=z.length-1;B>=0;B--){var F=$(this).data("mid");m.push(F);H(z.eq(B),C)}function H(M,L){var K=parseInt(M.data("timestamp"),10);if(L.length===0){$("#"+G).append(M)}else{var L=$("#"+G).find(".new");for(var J=0,I=L.length;J<I;J++){if(parseInt(L.eq(J).data("timestamp"))>K){M.insertBefore(L.eq(J));break}}if(J===L.length){M.insertAfter(L.last())}}}}f.on("click",".get-history-btn",function(B){B.preventDefault();var A=$(this).parent();var z=A.attr("id");var y=$(this);p(z).done(function(C){console.log("获取最近10条信息");var D=c(C.chatRecordList,z,false);o(D,A.data("id"),false);if(C.chatRecordList.length<j){y.text("你与"+A.data("name")+"聊天记录已全部加载");y.delay(2500).fadeOut("400",function(){})}}).fail(function(){console.log("err")})});v.on("click","li",function(z){z.preventDefault();var y=$(this).data("userId").trim();if(y.length===0){n.prop("disabled",true)}else{n.prop("disabled",false)}a.val($(this).data("userId"));d.text($(this).text());f.find("#"+y).siblings("div").removeClass("active").end().addClass("active")});n.prop("disabled",true).attr("title","请选选择交流对象");function r(B,y){var A=$("#"+y);var z=""}function c(B,H,I){var C=$("#"+H);var z="";if(B==undefined){console.log("无数据");return}console.log(B);if(!(B.hasOwnProperty("length"))){B=[B]}var D,F;for(var D=F=B.length-1;D>=0;D--){var A=B[D];var G=l(A)?"me":"other";var E=A.belong=="2"?A.doctor_id:A.patient_id;var y=G==="me"?"我：":("："+C.data("name"));if(D===F&&!I){G+=" first-history"}if(I){G+=" new"}z+='<div class="msg '+G+'" data-user-id="'+E+'" data-mid="'+A._id+'"  data-timestamp='+Date.parse(A.create_at)+'><span class="user-name">'+y+"</span>"+'<div class="msg-content">'+'<p class="time">'+moment(A.create_at).format("YYYY-MM-DD HH:mm:ss")+"</p>"+"<p>"+A.content+"</p>"+"</div>"+"</div>";if(D===F&&!I){$("#"+C.data("id")).data("last-msg-timestamp",Date.parse(A.create_at))}}return z}function l(z){var y;switch(USERROLE){case"2":y="doctor_id";break;case"3":y="patient_id";break}if(z.belong==USERROLE&&z[y]==USERID){return true}else{return false}}function p(A,z){z=z||j;var y=a.val();var B=Date.now();if(USERROLE=="2"){return $.ajax("/get_history_record?&patient_id="+y+"&doctor_id="+USERID+"&limit="+j+"&timestamp="+$("#"+A).data("last-msg-timestamp")+"&firstloadtimestamp="+g)}else{if(USERROLE=="3"){return $.ajax("/get_history_record?&patient_id="+USERID+"&doctor_id="+y+"&limit="+j+"&timestamp="+$("#"+A).data("last-msg-timestamp")+"&firstloadtimestamp="+g)}}}function o(C,z,A){if(A==undefined){A=true}var B=$("#"+z);if(A){B.append(C)}else{var D=B.find(".first-history:first");if(D.length===0){var y=B.find(".new");if(y.length>0){y.first().before(C)}else{B.prepend(C)}}else{D.before(C)}}}function u(y){return Math.max.apply(null,y)}});
