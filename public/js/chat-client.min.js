$(function(){function p(a,b){function f(a,b){var d,e,c=parseInt(a.data("timestamp"),10);for(d=0,e=b.length;e>d;d++)if(parseInt(b.eq(d).data("timestamp"))>c){a.insertBefore(b.eq(d));break}d===b.length&&a.insertAfter(b.last())}var c=q(a.chatRecordList,b,!0),d=$(c),e=$("#"+b).find(".new");0===e.length?$("#"+b).append(d):d.each(function(){$(this).addClass("pollMsg"),f($(this),e)})}function q(a,b,c){var f,g,h,i,j,k,d=$("#"+b),e="";if(void 0==a)return console.log("无数据"),void 0;for(a.hasOwnProperty("length")||(a=[a]),f=0,g=a.length;g>f;f++)h=a[f],i=r(h)?"me":"other",j="2"==h.belong?h.doctor_id:h.patient_id,console.log(i),k="me"===i?"我：":"："+d.data("name"),f!==g-1||c||(i+=" last-history"),c&&(i+=" new"),e+='<div class="msg '+i+'" data-user-id="'+j+'"  data-timestamp='+Date.parse(h.create_at)+'><span class="user-name">'+k+"</span>"+'<div class="msg-content">'+'<p class="time">'+moment(h.create_at).format("YYYY-MM-DD HH:mm:ss")+"</p>"+"<p>"+h.content+"</p>"+"</div>"+"</div>",f!==g-1||c||$("#"+d.data("id")).data("last-msg-timestamp",Date.parse(h.create_at));return e}function r(a){var b;switch(USERROLE){case"2":b="doctor_id";break;case"3":b="patient_id"}return a.belong==USERROLE&&a[b]==USERID?!0:!1}function s(b,c){c=c||a;var d=k.val();return Date.now(),"2"==USERROLE?$.ajax("/get_chat_record?&patient_id="+d+"&doctor_id="+USERID+"&limit="+a+"&timestamp="+$("#"+b).data("last-msg-timestamp")+"&firstloadtimestamp="+m):"3"==USERROLE?$.ajax("/get_chat_record?&patient_id="+USERID+"&doctor_id="+d+"&limit="+a+"&timestamp="+$("#"+b).data("last-msg-timestamp")+"&firstloadtimestamp="+m):void 0}function t(a,b,c){var d,e,f;void 0==c&&(c=!0),d=$("#"+b),c?d.append(a):(e=d.find(".last-history:last"),0===e.length?(f=d.find(".new"),f.length>0?f.first().before(a):d.append(a)):e.after(a))}var m,n,o,a=10,b=3500,c=$("#chat-container"),d=c.find("form"),e=c.find("textarea"),f=c.find(":submit"),g=c.find(".content-list"),h=$("#talk-people"),i=h.find("button:first"),j=h.find(".dropdown-menu"),k=$("[name=talk_people_id]");$(".get-history-btn"),m=Date.now(),n=[],c.on("click",".nav",function(a){a.preventDefault(),c.toggleClass("active"),c.hasClass("active")?o.boot(n):(console.log(n),o.stop())}),d.submit(function(a){a.preventDefault();var b=e.val().trim();$.post("/save_chat_record",{talk_people_id:k.val(),message:b},function(a){if(1==a.status){var b=q(a.chatRecord,g.children("div.active").data("id"),!0);t(b,g.children("div.active").data("id"),!0),e.val("")}}).fail(function(){alert("发送失败")})}),$.get("/get_talk_people",function(b){var c,d,e,f,h;if(1==b.status){for(c="",d="",e=0,f=b.userList.length;f>e;e++)h=b.userList[e],c+="<li data-user-id='"+h._id+"'><a href='javascript:;'>"+h.role_prop.real_name+"</a></li>",d+="<div id="+h._id+" data-id="+h._id+" data-name="+h.role_prop.real_name+" class='user-chat-content' data-last-msg-timestamp="+0+"><div class='get-history-btn'>点击获取最近与"+h.role_prop.real_name+"的"+a+"条信息</div></div>";j.html(c),g.html(d),g.children("div").each(function(){var b=$(this).attr("id");n.push(b)})}}),o=function(){function d(d,e){function h(a){var b=Date.now();"2"==USERROLE?$.ajax("/get_chat_record?belong=3&patient_id="+a+"&doctor_id="+USERID+"&limit="+e+"&timestamp="+($("#"+a).find(".pollMsg:last").data("timestamp")||m)+"&random="+b).done(function(b){p(b,a)}).fail():"3"==USERROLE&&$.ajax("/get_chat_record?belong=2&patient_id="+USERID+"&doctor_id="+a+"&limit="+e+"&timestamp="+($("#"+a).find(".pollMsg:last").data("timestamp")||m)+"&random="+b).done(function(b){p(b,a)}).fail()}if(!a){e=e||0;for(var f=0,g=d.length;g>f;f++)!function(a){c[a]=setInterval(function(){h(a)},b),h(a)}(d[f]);a=!0}}function e(){for(var b in c)console.log(b),c.hasOwnProperty(b)&&clearInterval(c[b]);a=!1}var a=!1,c={};return{boot:d,stop:e}}(),g.on("click",".get-history-btn",function(b){var c,d,e;b.preventDefault(),c=$(this).parent(),d=c.attr("id"),e=$(this),s(d).done(function(b){console.log("获取最近10条信息"),console.log(b);var f=q(b.chatRecordList,d,!1);t(f,c.data("id"),!1),b.chatRecordList.length<a&&(e.text("你与"+c.data("name")+"聊天记录已全部加载"),e.delay(2500).fadeOut("400",function(){}))}).fail(function(){console.log("err")})}),j.on("click","li",function(a){a.preventDefault();var b=$(this).data("userId").trim();0===b.length?f.prop("disabled",!0):f.prop("disabled",!1),k.val($(this).data("userId")),i.text($(this).text()),g.find("#"+b).siblings("div").removeClass("active").end().addClass("active")}),f.prop("disabled",!0).attr("title","请选选择交流对象")});