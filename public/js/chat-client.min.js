$(function(){function t(t,e){function i(t,a){for(var e=parseInt(t.data("timestamp"),10),i=0,n=a.length;n>i;i++)if(parseInt(a.eq(i).data("timestamp"))>e){t.insertBefore(a.eq(i));break}i===a.length&&t.insertAfter(a.last())}var n=a(t.chatRecordList,e,!0),o=$(n),r=$("#"+e).find(".new");0===r.length?$("#"+e).append(o):o.each(function(t){$(this).addClass("pollMsg"),i($(this),r)})}function a(t,a,i){var n=$("#"+a),o="";if(void 0==t)return void console.log("无数据");t.hasOwnProperty("length")||(t=[t]);for(var r=0,s=t.length;s>r;r++){var d=t[r],l=e(d)?"me":"other",c="2"==d.belong?d.doctor_id:d.patient_id;console.log(l);var p="me"===l?"我：":"："+n.data("name");r!==s-1||i||(l+=" last-history"),i&&(l+=" new"),o+='<div class="msg '+l+'" data-user-id="'+c+'"  data-timestamp='+Date.parse(d.create_at)+'><span class="user-name">'+p+'</span><div class="msg-content"><p class="time">'+moment(d.create_at).format("YYYY-MM-DD HH:mm:ss")+"</p><p>"+d.content+"</p></div></div>",r!==s-1||i||$("#"+n.data("id")).data("last-msg-timestamp",Date.parse(d.create_at))}return o}function e(t){var a;switch(USERROLE){case"2":a="doctor_id";break;case"3":a="patient_id"}return t.belong==USERROLE&&t[a]==USERID}function i(t,a){a=a||o;var e=u.val();Date.now();return"2"==USERROLE?$.ajax("/get_chat_record?&patient_id="+e+"&doctor_id="+USERID+"&limit="+o+"&timestamp="+$("#"+t).data("last-msg-timestamp")+"&firstloadtimestamp="+h):"3"==USERROLE?$.ajax("/get_chat_record?&patient_id="+USERID+"&doctor_id="+e+"&limit="+o+"&timestamp="+$("#"+t).data("last-msg-timestamp")+"&firstloadtimestamp="+h):void 0}function n(t,a,e){void 0==e&&(e=!0);var i=$("#"+a);if(e)i.append(t);else{var n=i.find(".last-history:last");if(0===n.length){var o=i.find(".new");o.length>0?o.first().before(t):i.append(t)}else n.after(t)}}var o=10,r=3500,s=$("#chat-container"),d=s.find("form"),l=s.find("textarea"),c=s.find(":submit"),p=s.find(".content-list"),f=$("#talk-people"),m=f.find("button:first"),v=f.find(".dropdown-menu"),u=$("[name=talk_people_id]"),h=($(".get-history-btn"),Date.now()),g=[];s.on("click",".nav",function(t){t.preventDefault(),s.toggleClass("active"),s.hasClass("active")?_.boot(g):(console.log(g),_.stop())}),d.submit(function(t){t.preventDefault();var e=l.val().trim();$.post("/save_chat_record",{talk_people_id:u.val(),message:e},function(t){if(1==t.status){var e=a(t.chatRecord,p.children("div.active").data("id"),!0);n(e,p.children("div.active").data("id"),!0),l.val("")}})}),$.get("/get_talk_people",function(t){if(1==t.status){for(var a="",e="",i=0,n=t.userList.length;n>i;i++){var r=t.userList[i];a+="<li data-user-id='"+r._id+"'><a href='javascript:;'>"+r.role_prop.real_name+"</a></li>",e+="<div id="+r._id+" data-id="+r._id+" data-name="+r.role_prop.real_name+" class='user-chat-content' data-last-msg-timestamp=0><div class='get-history-btn'>点击获取最近与"+r.role_prop.real_name+"的"+o+"条信息</div></div>"}v.html(a),p.html(e),p.children("div").each(function(t){var a=$(this).attr("id");g.push(a)})}});var _=function(){function a(a,e){function o(a){var i=Date.now();"2"==USERROLE?$.ajax("/get_chat_record?belong=3&patient_id="+a+"&doctor_id="+USERID+"&limit="+e+"&timestamp="+($("#"+a).find(".pollMsg:last").data("timestamp")||h)+"&random="+i).done(function(e){t(e,a)}).fail():"3"==USERROLE&&$.ajax("/get_chat_record?belong=2&patient_id="+USERID+"&doctor_id="+a+"&limit="+e+"&timestamp="+($("#"+a).find(".pollMsg:last").data("timestamp")||h)+"&random="+i).done(function(e){t(e,a)}).fail()}if(!i){e=e||0;for(var s=0,d=a.length;d>s;s++)!function(t){n[t]=setInterval(function(){o(t)},r),o(t)}(a[s]);i=!0}}function e(){for(var t in n)console.log(t),n.hasOwnProperty(t)&&clearInterval(n[t]);i=!1}var i=!1,n={};return{boot:a,stop:e}}();p.on("click",".get-history-btn",function(t){t.preventDefault();var e=$(this).parent(),r=e.attr("id"),s=$(this);i(r).done(function(t){console.log("获取最近10条信息"),console.log(t);var i=a(t.chatRecordList,r,!1);n(i,e.data("id"),!1),t.chatRecordList.length<o&&(s.text("你与"+e.data("name")+"聊天记录已全部加载"),s.delay(2500).fadeOut("400",function(){}))}).fail(function(){console.log("err")})}),v.on("click","li",function(t){t.preventDefault();var a=$(this).data("userId").trim();0===a.length?c.prop("disabled",!0):c.prop("disabled",!1),u.val($(this).data("userId")),m.text($(this).text()),p.find("#"+a).siblings("div").removeClass("active").end().addClass("active")}),c.prop("disabled",!0).attr("title","请选选择交流对象")});