var editUserDialog,curTr,editUserForm,searchForm,userList,addUserDialog=$("#add-user"),addUserForm=addUserDialog.find("form"),userTable=$("table");addUserDialog.find("form").submit(function(a){var b,c,d,e,f;return a.preventDefault(),b=!0,c=$("[name=account]").val().trim(),d=$("[name=password]").val().trim(),e=$("#confirm-pass").val().trim(),f=$("[name=real_name]").val().trim(),0!==c.length?/[^\w\.@]/g.test(c)?(alert("帐号存在非法字符"),b=!1):c.length<3&&(alert("账号长度小于3"),b=!1):(alert("账号不能为空"),b=!1),d.length<4||e.length<4?(alert("密码长度小于4"),b=!1):d!==e&&(alert("密码与确认密码不一致"),b=!1),0===f.length&&(alert("姓名不能为空"),b=!1),b?($.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(a){var b,c;alert(a.info),a.status&&(b=a.user,c=0==b.role?"":'<button type="button" class="btn btn-danger del_btn">删除</button>',$("<tr data-uid="+b.uid+" data-role="+b.role+">"+"<td>"+b.account+"</td>"+"<td>"+b.real_name+"</td>"+"<td data-sex="+b.sex+">"+("0"==b.sex?"男":"女")+"</td>"+"<td>"+(0==b.role?"系统管理员":"管理员")+"</td>"+'<td><div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-warning edit_btn">编辑</button>'+c+"</div></td>"+"</tr>").prependTo(userTable.find("tbody")),addUserDialog.modal("hide"),addUserForm.trigger("reset"))}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)}),void 0):(console.log("验证失败"),void 0)}),editUserDialog=$("#edit-user"),curTr=null,userTable.find("tbody").on("click",".edit_btn",function(){curTr=$(this).closest("tr");var b=curTr.find("td");editUserDialog.find("[name='account']").val(b.eq(0).text()).end().find("[name='real_name']").val(b.eq(1).text()).end().find("[name='sex']").each(function(){return $(this).val()==b.eq(2).data("sex")?($(this).prop("checked",!0),!1):void 0}).end().find("[name='role']").each(function(){return $(this).val()==curTr.data("role")?($(this).prop("checked",!0),!1):void 0}).end().find("[name=edit_user_id]").val(curTr.data("uid")),editUserDialog.modal("show")}).on("click",".del_btn",function(a){if(a.preventDefault(),window.confirm("确定要删除吗？")){var b=$(this).closest("tr");$.get("/del_user?uid="+b.data("uid"),function(a){a.status===!0&&b.remove()})}}),editUserDialog=$("#edit-user"),editUserForm=editUserDialog.find("form"),editUserDialog.find(":submit").click(function(){$.ajax({url:editUserForm.attr("action"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(a){alert(a.info),a.status&&(a.user,curTr.find("td").eq(1).text(a.user.real_name).end().eq(2).text(0==a.user.sex?"男":"女"),editUserDialog.modal("hide"),editUserForm.trigger("reset"))}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),searchForm=$("#search-form"),userList=$("#userlist").find("tbody"),searchForm.submit(function(a){a.preventDefault(),$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(a){var b,c,d,e;for(console.log(a),userList.empty(),b=0,c=a.userList.length;c>b;b++)d=a.userList[b],e=0==d.role?"":'<button type="button" class="btn btn-danger del_btn">删除</button>',$('<tr data-uid="'+d._id+'" data-role="'+d.role+'">'+"<td>"+d.account+"</td>"+"<td>"+d.role_prop.real_name+"</td>"+'<td data-sex="0">'+(0==d.role_prop.sex?"男":"女")+"</td>"+"<td>"+d.role_prop.age+"</td>"+'<td><div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-warning edit_btn">编辑</button>'+e+"</tr>").appendTo(userList)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})});