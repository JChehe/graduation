var addUserDialog=$("#add-user");var addUserForm=addUserDialog.find("form");var userTable=$("table");addUserDialog.find("form").submit(function(d){d.preventDefault();var b=true;var c=addUserDialog.find("[name=account]").val().trim();var f=addUserDialog.find("[name=password]").val().trim();var a=addUserDialog.find("#confirm-pass").val().trim();var e=addUserDialog.find("[name=real_name]").val().trim();if(c.length!==0){if(/[^\w\.@]/g.test(c)){alert("帐号存在非法字符");b=false}else{if(c.length<3){alert("账号长度小于3");b=false}}}else{alert("账号不能为空");b=false}if(f.length<4||a.length<4){alert("密码长度小于4");b=false}else{if(f!==a){alert("密码与确认密码不一致");b=false}}if(e.length===0){alert("姓名不能为空");b=false}if(!b){console.log("验证失败");return}$.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(h){alert(h.info);if(h.status){var g=h.user;var i=g.role==0?"":'<button type="button" class="btn btn-danger del_btn">删除</button>';$("<tr data-uid="+g.uid+" data-role="+g.role+">"+"<td>"+g.account+"</td>"+"<td>"+g.real_name+"</td>"+"<td data-sex="+g.sex+">"+(g.sex=="0"?"男":"女")+"</td>"+"<td>"+(g.role==0?"系统管理员":"管理员")+"</td>"+'<td><div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-warning edit_btn">编辑</button>'+i+"</div></td>"+"</tr>").prependTo(userTable.find("tbody"));addUserDialog.modal("hide");addUserForm.trigger("reset")}else{}}).fail(function(g,i,h){console.log("textStatus:"+i);console.log("errorThrown:"+h)})});var editUserDialog=$("#edit-user");var curTr=null;userTable.find("tbody").on("click",".edit_btn",function(b){curTr=$(this).closest("tr");var a=curTr.find("td");editUserDialog.find("[name='account']").val(a.eq(0).text()).end().find("[name='real_name']").val(a.eq(1).text()).end().find("[name='sex']").each(function(){if($(this).val()==a.eq(2).data("sex")){$(this).prop("checked",true);return false}}).end().find("[name='role']").each(function(){if($(this).val()==curTr.data("role")){$(this).prop("checked",true);return false}}).end().find("[name=edit_user_id]").val(curTr.data("uid"));editUserDialog.modal("show")}).on("click",".del_btn",function(b){b.preventDefault();if(window.confirm("确定要删除吗？")){var a=$(this).closest("tr");$.get("/del_user?uid="+a.data("uid"),function(c){if(c.status===true){a.remove()}})}});var editUserDialog=$("#edit-user");var editUserForm=editUserDialog.find("form");editUserDialog.find(":submit").click(function(a){$.ajax({url:editUserForm.attr("action"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(c){alert(c.info);if(c.status){var b=c.user;curTr.find("td").eq(1).text(c.user.real_name).end().eq(2).text(c.user.sex==0?"男":"女");editUserDialog.modal("hide");editUserForm.trigger("reset")}else{}}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});var searchForm=$("#search-form");var userList=$("#userlist").find("tbody");searchForm.submit(function(a){a.preventDefault();$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(d){console.log(d);userList.empty();for(var c=0,b=d.userList.length;c<b;c++){var f=d.userList[c];var e=f.role==0?"":'<button type="button" class="btn btn-danger del_btn">删除</button>';$('<tr data-uid="'+f._id+'" data-role="'+f.role+'">'+"<td>"+f.account+"</td>"+"<td>"+f.role_prop.real_name+"</td>"+'<td data-sex="0">'+(f.role_prop.sex==0?"男":"女")+"</td>"+"<td>"+f.role_prop.age+"</td>"+'<td><div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-warning edit_btn">编辑</button>'+e+"</tr>").appendTo(userList)}}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});
