var editUserDialog,curTr,editUserForm,familyDialog,familyTbody,familyForm,curPatientId,isFamilyCreate,curPatient,searchForm,userList,addUserDialog=$("#add-user"),addUserForm=addUserDialog.find("form"),userTable=$("table");addUserDialog.find(":submit").click(function(a){a.preventDefault();var b=!0;addUserForm.find(":input").each(function(){return 0===$(this).val().trim().length?(alert("有表单没填写"),b=!1,!1):void 0}),b&&$.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(a){if(a.status){var b=a.user;$("<tr data-uid="+b._id+" data-role="+b.role+' data-idcard="'+b.id_card+'" data-height="'+b.height+'" data-weight="'+b.weight+'" data-birthday="'+b.birthday+'" data-medicalcase="'+b.medical_case+'">'+"<td>"+b.account+"</td>"+"<td>"+b.real_name+"</td>"+"<td data-sex="+b.sex+">"+("0"==b.sex?"男":"女")+"</td>"+"<td>"+(void 0==b.age?"未填写":b.age)+"</td>"+"<td>"+b.address+"</td>"+"<td>"+b.phone+"</td>"+"<td>"+b.tel_phone+"</td>"+'<td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success family_btn">查看家属</button><button type="button" class="btn btn-danger">删除</button></div></td>'+"</tr>").prependTo(userTable.find("tbody")),addUserDialog.modal("hide"),addUserForm.trigger("reset")}else alert(a.info)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),editUserDialog=$("#edit-user"),curTr=null,userTable.find("tbody").on("click",".edit_btn",function(){curTr=$(this).closest("tr");var b=curTr.find("td");editUserDialog.find("[name='account']").val(b.eq(0).text()).end().find("[name='real_name']").val(b.eq(1).text()).end().find("[name='sex']").each(function(){return $(this).val()==b.eq(2).data("sex")?($(this).attr("checked",!0),!1):void 0}).end().find("[name='role']").each(function(){return $(this).val()==curTr.data("role")?($(this).attr("checked",!0),!1):void 0}).end().find("[name='id_card']").val(curTr.data("idcard")).end().find("[name='height']").val(curTr.data("height")).end().find("[name='weight']").val(curTr.data("weight")).end().find("[name='medical_case']").val(curTr.data("medicalcase")).end().find("[name='address']").val(b.eq(4).text()).end().find("[name='tel_phone']").val(b.eq(6).text()).end().find("[name='phone']").val(b.eq(5).text()).end().find("[name=edit_user_id]").val(curTr.data("uid")),editUserDialog.modal("show")}),editUserDialog=$("#edit-user"),editUserForm=editUserDialog.find("form"),editUserDialog.find(":submit").click(function(){$.ajax({url:editUserForm.attr("action"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(a){if(a.status){var b=a.user;curTr.find("td").eq(1).text(b.real_name).end().eq(2).text(0==b.sex?"男":"女").end().eq(3).text(b.age).end().eq(4).text(b.address).end().eq(5).text(b.phone).end().eq(6).text(b.tel_phone),curTr.data({idcard:b.id_card,height:b.height,weight:b.weight,birthday:b.birthday,medicalcase:b.medical_case}),editUserDialog.modal("hide"),editUserForm.trigger("reset")}}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),familyDialog=$("#family-dialog"),familyTbody=familyDialog.find("tbody"),familyForm=familyDialog.find("form"),curPatientId="",userTable.find("tbody").on("click",".family_btn",function(){var b=$(this).closest("tr");curPatientId=b.data("uid"),$("#family-form")[0].reset(),$("#close-family-form-btn").trigger("click"),$("#patient_id").val(curPatientId),$.ajax({url:"/get_family/"+curPatientId,type:"get"}).done(function(a){var b,c,d,e;for(console.log(a),b=a.familyList,familyTbody.empty(),c=0,d=b.length;d>c;c++)e=b[c],$("<tr data-family-id="+e._id+">"+"<td>"+e.name+"</td>"+"<td>"+e.tel_phone+"</td>"+"<td>"+e.relationship+"</td>"+"<td>"+(1==e.is_message?"是":"否")+"</td>"+"<td>"+e.remark+"</td>"+"<td>"+'<div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-default edit-family">编辑</button>'+'<button type="button" class="btn btn-danger del_family">删除</button>'+"</div>"+"</td>"+"</tr>").appendTo(familyTbody)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)}),familyDialog.modal("show")}),$("#close-family-form-btn").click(function(){familyForm.hide()}),isFamilyCreate=$("#family_id"),curPatient=null,$("#add-family-btn").click(function(){isFamilyCreate.val(""),familyForm[0].reset(),familyForm.show()}),familyTbody.on("click",".edit-family",function(){var c,d,b=$(this).closest("tr");curFamilyId=b.data("familyId"),isFamilyCreate.val(curFamilyId),familyForm.show(),c=b.find("td"),d="是"==c.eq(3).text()?0:1,familyForm.find("[name=name]").val(c.eq(0).text()).end().find("[name=relationship]").val(c.eq(1).text()).end().find("[name=tel_phone]").val(c.eq(2).text()).end().find("[name=is_message]").eq(d).prop("checked",!0).end().end().find("[name=remark]").val(c.eq(4).text())}),familyForm.submit(function(a){a.preventDefault();var b=isFamilyCreate.val();$.ajax({url:familyForm.attr("action")+"/"+curPatientId,type:familyForm.attr("method"),data:familyForm.serialize()}).done(function(a){var c,d;console.log("家属后的操作："),console.log(a),c=a.family,1==a.status&&(""==b?$("<tr data-family-id="+c._id+">"+"<td>"+c.name+"</td>"+"<td>"+c.tel_phone+"</td>"+"<td>"+c.relationship+"</td>"+"<td>"+(1==c.is_message?"是":"否")+"</td>"+"<td>"+c.remark+"</td>"+"<td>"+'<div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-default">编辑</button>'+'<button type="button" class="btn btn-danger del_user">删除</button>'+"</div>"+"</td>"+"</tr>").appendTo(familyTbody):(d=familyTbody.find("[data-family-id="+c._id+"]"),d.find("td").eq(0).text(c.name).end().eq(1).text(c.tel_phone).end().eq(2).text(c.relationship).end().eq(3).text(1==c.is_message?"是":"否").end().eq(4).text(c.remark)),familyForm[0].reset())}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),familyDialog.on("click",".del_family",function(){var b=$(this).closest("tr");$.get("/del_family/"+b.data("familyId"),function(a){1==a.status&&b.remove()})}),searchForm=$("#search-form"),userList=$("#userlist").find("tbody"),searchForm.submit(function(a){a.preventDefault(),$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(a){var b,c,d,e;for(console.log(a),userList.empty(),b="",c=0,d=a.userList.length;d>c;c++)e=a.userList[c],b+='<tr data-uid="'+e._id+'" data-role="3" data-idcard="'+e.role_prop.id_card+'" data-height="'+e.role_prop.height+'" data-weight="'+e.role_prop.weight+'" data-birthday="'+e.role_prop.birthday+'" data-medicalcase="'+e.role_prop.medical_case+'">'+"<td>"+e.account+"</td>"+"<td>"+e.role_prop.real_name+"</td>"+'<td data-sex="'+e.role_prop.sex+'">'+(0==e.role_prop.sex?"男":"女")+"</td>"+"<td>"+e.role_prop.age+"</td>"+"<td>"+e.role_prop.address+"</td>"+"<td>"+e.role_prop.phone+"</td>"+"<td>"+e.role_prop.tel_phone+"</td>"+"<td>"+'<div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-default edit_btn">查看/编辑</button>'+'<button type="button" class="btn btn-success family_btn">查看家属</button>'+'<button type="button" class="btn btn-danger del_user">删除</button>'+"</div>"+"</td>"+"</tr>";userList.html(b)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),userList.on("click",".del_user",function(a){var b,c;a.preventDefault(),window.confirm("确认要删除吗？")&&(b=$(this).closest("tr"),c=b.data("uid"),$.get("/del_user?uid="+c,function(a){console.log(a),b.remove()}))});