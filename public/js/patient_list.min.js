var addUserDialog=$("#add-user");var addUserForm=addUserDialog.find("form");var userTable=$("table");addUserDialog.find(":submit").click(function(a){a.preventDefault();var b=true;addUserForm.find(":input").each(function(){if($(this).val().trim().length===0){alert("有表单没填写");b=false;return false}});if(!b){return}$.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(d){if(d.status){var c=d.user;$("<tr data-uid="+c._id+" data-role="+c.role+' data-idcard="'+c.id_card+'" data-height="'+c.height+'" data-weight="'+c.weight+'" data-birthday="'+c.birthday+'" data-medicalcase="'+c.medical_case+'"><td>'+c.account+"</td><td>"+c.real_name+"</td><td data-sex="+c.sex+">"+(c.sex=="0"?"男":"女")+"</td><td>"+(c.age==undefined?"未填写":c.age)+"</td><td>"+c.address+"</td><td>"+c.phone+"</td><td>"+c.tel_phone+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success family_btn">查看家属</button><button type="button" class="btn btn-danger">删除</button></div></td></tr>').prependTo(userTable.find("tbody"));addUserDialog.modal("hide");addUserForm.trigger("reset")}else{alert(d.info)}}).fail(function(c,e,d){console.log("textStatus:"+e);console.log("errorThrown:"+d)})});var editUserDialog=$("#edit-user");var curTr=null;userTable.find("tbody").on("click",".edit_btn",function(b){curTr=$(this).closest("tr");var a=curTr.find("td");editUserDialog.find("[name='account']").val(a.eq(0).text()).end().find("[name='real_name']").val(a.eq(1).text()).end().find("[name='sex']").each(function(){if($(this).val()==a.eq(2).data("sex")){$(this).attr("checked",true);return false}}).end().find("[name='role']").each(function(){if($(this).val()==curTr.data("role")){$(this).attr("checked",true);return false}}).end().find("[name='id_card']").val(curTr.data("idcard")).end().find("[name='height']").val(curTr.data("height")).end().find("[name='weight']").val(curTr.data("weight")).end().find("[name='medical_case']").val(curTr.data("medicalcase")).end().find("[name='address']").val(a.eq(4).text()).end().find("[name='tel_phone']").val(a.eq(6).text()).end().find("[name='phone']").val(a.eq(5).text()).end().find("[name=edit_user_id]").val(curTr.data("uid"));editUserDialog.modal("show")});var editUserDialog=$("#edit-user");var editUserForm=editUserDialog.find("form");editUserDialog.find(":submit").click(function(a){$.ajax({url:editUserForm.attr("action"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(c){if(c.status){var b=c.user;curTr.find("td").eq(1).text(b.real_name).end().eq(2).text(b.sex==0?"男":"女").end().eq(3).text(b.age).end().eq(4).text(b.address).end().eq(5).text(b.phone).end().eq(6).text(b.tel_phone);curTr.data({idcard:b.id_card,height:b.height,weight:b.weight,birthday:b.birthday,medicalcase:b.medical_case});editUserDialog.modal("hide");editUserForm.trigger("reset")}else{}}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});var familyDialog=$("#family-dialog");var familyTbody=familyDialog.find("tbody");var familyForm=familyDialog.find("form");var curPatientId="";userTable.find("tbody").on("click",".family_btn",function(b){var a=$(this).closest("tr");curPatientId=a.data("uid");$("#family-form")[0].reset();$("#close-family-form-btn").trigger("click");$("#patient_id").val(curPatientId);$.ajax({url:"/get_family/"+curPatientId,type:"get"}).done(function(g){console.log(g);var f=g.familyList;familyTbody.empty();for(var e=0,c=f.length;e<c;e++){var d=f[e];$("<tr data-family-id="+d._id+"><td>"+d.name+"</td><td>"+d.tel_phone+"</td><td>"+d.relationship+"</td><td>"+d.remark+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit-family">编辑</button><button type="button" class="btn btn-danger del_family">删除</button></div></td></tr>').appendTo(familyTbody)}}).fail(function(c,e,d){console.log("textStatus:"+e);console.log("errorThrown:"+d)});familyDialog.modal("show")});$("#close-family-form-btn").click(function(){familyForm.hide()});var isFamilyCreate=$("#family_id");var curPatient=null;$("#add-family-btn").click(function(a){isFamilyCreate.val("");familyForm[0].reset();familyForm.show()});familyTbody.on("click",".edit-family",function(b){var d=$(this).closest("tr");curFamilyId=d.data("familyId");isFamilyCreate.val(curFamilyId);familyForm.show();var a=d.find("td");var c=(a.eq(3).text()=="是"?0:1);familyForm.find("[name=name]").val(a.eq(0).text()).end().find("[name=relationship]").val(a.eq(1).text()).end().find("[name=tel_phone]").val(a.eq(2).text()).end().find("[name=is_message]").eq(c).prop("checked",true).end().end().find("[name=remark]").val(a.eq(3).text())});familyForm.submit(function(b){b.preventDefault();var a=isFamilyCreate.val();$.ajax({url:familyForm.attr("action")+"/"+curPatientId,type:familyForm.attr("method"),data:familyForm.serialize()}).done(function(e){console.log("家属后的操作：");console.log(e);var c=e.family;if(e.status==true){if(a==""){$("<tr data-family-id="+c._id+"><td>"+c.name+"</td><td>"+c.tel_phone+"</td><td>"+c.relationship+"</td><td>"+(c.is_message==true?"是":"否")+"</td><td>"+c.remark+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default">编辑</button><button type="button" class="btn btn-danger del_user">删除</button></div></td></tr>').appendTo(familyTbody)}else{var d=familyTbody.find("[data-family-id="+c._id+"]");d.find("td").eq(0).text(c.name).end().eq(1).text(c.tel_phone).end().eq(2).text(c.relationship).end().eq(3).text(c.is_message==true?"是":"否").end().eq(4).text(c.remark)}familyForm[0].reset()}}).fail(function(c,e,d){console.log("textStatus:"+e);console.log("errorThrown:"+d)})});familyDialog.on("click",".del_family",function(a){var b=$(this).closest("tr");$.get("/del_family/"+b.data("familyId"),function(c){if(c.status==true){b.remove()}})});var searchForm=$("#search-form");var userList=$("#userlist").find("tbody");searchForm.submit(function(a){a.preventDefault();$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(e){console.log(e);userList.empty();var f="";for(var d=0,b=e.userList.length;d<b;d++){var c=e.userList[d];f+=('<tr data-uid="'+c._id+'" data-role="3" data-idcard="'+c.role_prop.id_card+'" data-height="'+c.role_prop.height+'" data-weight="'+c.role_prop.weight+'" data-birthday="'+c.role_prop.birthday+'" data-medicalcase="'+c.role_prop.medical_case+'"><td>'+c.account+"</td><td>"+c.role_prop.real_name+'</td><td data-sex="'+c.role_prop.sex+'">'+(c.role_prop.sex==0?"男":"女")+"</td><td>"+c.role_prop.age+"</td><td>"+c.role_prop.address+"</td><td>"+c.role_prop.phone+"</td><td>"+c.role_prop.tel_phone+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success family_btn">查看家属</button><button type="button" class="btn btn-danger del_user">删除</button></div></td></tr>')}userList.html(f)}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});userList.on("click",".del_user",function(b){b.preventDefault();if(window.confirm("确认要删除吗？")){var c=$(this).closest("tr");var a=c.data("uid");$.get("/del_user?uid="+a,function(d){console.log(d);c.remove()})}});
