function toggleSound(){.5==aud.volume?aud.volume=0:(aud.pause(),aud.currentTime=0,aud.play(),aud.volume=.5)}function beep(){aud.pause(),aud.currentTime=0,aud.play()}function rand(e,a){return e+Math.floor(Math.random()*(a-e))}function addtrace(e,a){for(loop=0;loop<a.length;loop++)e.hasOwnProperty(loop)?e[loop]=e[loop]+a[loop]:e[loop]=a[loop]}function drawlayer1(){var e=document.getElementById("ecg_bg");if(e.getContext){var a=e.getContext("2d");for(a.beginPath(),h=1;h<=60;h++){for(i=1;i<16;i++)a.moveTo(20*h-.5,25*i+.5),a.lineTo(20*h-20.5,25*i+.5);a.moveTo(20*h-.5,0),a.lineTo(20*h-.5,400)}a.strokeStyle="#121",a.stroke()}}function mainLoop(){if(canvas.getContext){var e=canvas.getContext("2d");for(e.lineCap="round",e.beginPath(),i=0;i<5;i++)trace.hasOwnProperty(0)?(ecg=trace[0],trace.splice(0,1)):ecg=0,z+=1,e.moveTo(x+.5,75.5-ecgold),x+=1,e.lineTo(x+.5,75.5-ecg),ecgold=ecg;e.strokeStyle="#8f8",e.stroke();var e=canvas.getContext("2d");for(e.beginPath(),i=0;i<5;i++)val=10*(.1*Math.sin((z+i)/3)+.3*Math.sin((z+i)/5)+.2*Math.sin((z+i)/7)+.4*Math.sin((z+i)/11)),e.moveTo(x-5+i+.5,205.5-valprev),e.lineTo(x-4+i+.5,205.5-val),valprev=val;x>=canvas.width&&(x=0),e.strokeStyle="#f00",e.stroke(),e.beginPath(),e.clearRect(xclear,0,6,400),xclear+=5,xclear>=canvas.width&&(xclear=0),e.font="16px Arial",e.fillStyle="#575",e.strokeStyle="#575",e.clearRect(10,canvas.height-50,400,50),e.fillText((loop20/20).toFixed(2)+"   "+rhythm+" "+(1200/hrate).toFixed(0)+" "+beat,10,canvas.height-5);var a=20*Math.sin(z/50);1>a&&(a=1),e.beginPath(),e.arc(30,300,a,0,2*Math.PI,!1),e.strokeStyle="yellow",e.lineWidth=3,e.clearRect(0,250,100,100),e.stroke(),e.lineWidth=1}0==rand(0,100)&&(hrate=rand(12,20),rhythm="sinus",0==rand(0,3)&&(rhythm="tachy",hrate=rand(6,12)),0==rand(0,3)&&(rhythm="brady",hrate=rand(20,240))),loop20%hrate==1&&(beep(),beat="sinusbeat",0==rand(0,5)&&(beat="ectopic"),"sinusbeat"==beat&&addtrace(trace,pqrs),"ectopic"==beat&&addtrace(trace,ectopic)),loop20++,setTimeout(function(){requestAnimationFrame(mainLoop)},39)}var loop,loop20=0,x=0,z=0,xclear=40,ecg=0,ecgold=0,val=0,valprev=0,hrate=15,rhythm="sinus",beat="sinusbeat",trace=[0],gap5=[0,0,0,0,0],p=[1,1,2,4,5,6,6,5,4,2,1,1,0],qrs=[1,2,4,22,57,26,-10,-15,-10,-6,-4,-2,-2,-1,0,0,1,1,2,2,3,4,6,8,11,13,14,15,14,13,10,7,5,4,3,2,2,1,1,1,0],pqrs=p.concat(gap5,qrs),ectopic=[-1,-1,-2,-5,-12,-24,-40,-49,-50,-50,-49,-34,-25,-1,12,20,31,37,40,45,46,47,48,49,49,48,47,46,42,40,35,32,27,23,20,17,14,12,7,5,3,2,2,1,1,1,1,0],canvas=document.getElementById("ecg"),aud=new Audio;aud.finished=-1,aud.src=document.getElementById("audio1").src,aud.load(),aud.volume=0,window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),window.onload=function(){drawlayer1(),requestAnimationFrame(mainLoop)};var canvas=document.getElementById("ecg"),ecg=$("#ecg");$("#save_ecg").click(function(){window.print()}),$("#save_img").click(function(){window.open(canvas.toDataURL("image/jpeg",1),"smallwin","width=400,height=350")});var eventImgInput=$("#event-img");$("#uploda_img").click(function(e){e.preventDefault(),eventImgInput.val(canvas.toDataURL("image/png",.8).replace(/^data:image\/\w+;base64,/,""))}),$(".ecg-form").submit(function(e){e.preventDefault();var a=$(this);$.post("/upload_event",a.serialize(),function(e){console.log(e)})});