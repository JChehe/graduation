var editUserDialog,curTr,editUserForm,patientDialog,patientTbody,searchForm,userList,addUserDialog=$("#add-user"),addUserForm=addUserDialog.find("form"),userTable=$("table");addUserDialog.find(":submit").click(function(a){a.preventDefault(),$.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(a){if(a.status){var b=a.user;$("<tr data-uid="+b.uid+" data-role="+b.role+">"+"<td>"+b.account+"</td>"+"<td>"+b.real_name+"</td>"+"<td data-sex="+b.sex+">"+("0"==b.sex?"男":"女")+"</td>"+"<td>"+(void 0==b.age?"未填写":b.age)+"</td>"+"<td>"+b.title+"</td>"+"<td>"+b.location+"</td>"+"<td>"+b.phone+"</td>"+"<td>"+b.tel_phone+"</td>"+'<td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success patient_btn">查看家属</button><button type="button" class="btn btn-danger del_user">删除</button></div></td>'+"</tr>").prependTo(userTable.find("tbody")),addUserDialog.modal("hide"),addUserForm.trigger("reset")}else alert(a.info)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),editUserDialog=$("#edit-user"),curTr=null,userTable.find("tbody").on("click",".edit_btn",function(){curTr=$(this).closest("tr");var b=curTr.find("td");editUserDialog.find("[name='account']").val(b.eq(0).text()).end().find("[name='real_name']").val(b.eq(1).text()).end().find("[name='sex']").each(function(){return $(this).val()==b.eq(2).data("sex")?($(this).attr("checked",!0),!1):void 0}).end().find("[name='title']").val(b.eq(4).text()).end().find("[name='location']").val(b.eq(5).text()).end().find("[name='tel_phone']").val(b.eq(7).text()).end().find("[name='phone']").val(b.eq(6).text()).end().find("[name=edit_user_id]").val(curTr.data("uid")),editUserDialog.modal("show")}),editUserDialog=$("#edit-user"),editUserForm=editUserDialog.find("form"),editUserDialog.find(":submit").click(function(a){a.preventDefault(),$.ajax({url:editUserForm.attr("action")+"/"+curTr.data("uid"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(a){if(alert(a.info),a.status){var b=a.user;curTr.find("td").eq(1).text(b.real_name).end().eq(2).text(0==b.sex?"男":"女").end().eq(3).text(b.age).end().eq(4).text(b.title).end().eq(5).text(b.location).end().eq(6).text(b.phone).end().eq(6).text(b.tel_phone),editUserDialog.modal("hide"),editUserForm.trigger("reset")}}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),patientDialog=$("#patient-list"),patientTbody=patientDialog.find("table tbody"),userTable.find("tbody").on("click",".patient_btn",function(a){a.preventDefault(),curTr=$(this).closest("tr");var b=curTr.data("patientList");$("[name='doctor_id']").val(curTr.data("uid")),$("[name='origin_patient_list']").val(b),$.ajax({url:"/get_patient_list",type:"get"}).done(function(a){var c,d,e,f,g,h;for(patientTbody.empty(),c=a.patientList,d=0,e=c.length;e>d;d++)f=c[d],g=f.role_prop,h=!1,null!=b&&(h=curTr.data("patientList").indexOf(f._id)>-1),$('<tr><td><input type="checkbox" name="care_patient_id" value="'+f._id+'" '+(h?"checked":"")+">"+"</td>"+"<td>"+f.account+"</td>"+"<td>"+g.real_name+"</td>"+"<td>"+("0"==g.sex?"男":"女")+"</td>"+"<td>"+g.age+"</td>"+"<td>"+g.address+"</td>"+"<td>"+g.tel_phone+"</td>"+"<td>"+g.phone+"</td>"+"</tr>").appendTo(patientTbody)}),patientDialog.modal("show")}),searchForm=$("#search-form"),userList=$("#userlist").find("tbody"),searchForm.submit(function(a){a.preventDefault(),$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(a){var b,c,d,e;for(console.log(a),userList.empty(),b="",c=0,d=a.userList.length;d>c;c++)e=a.userList[c],b+='<tr data-uid="'+e._id+'" data-role="2" data-patient-list="'+e.care_patient+'">'+"<td>"+e.account+"</td>"+"<td>"+e.role_prop.real_name+"</td>"+'<td data-sex="'+e.role_prop.sex+'">'+("0"==e.role_prop.sex?"男":"女")+"</td>"+"<td>"+e.role_prop.age+"</td>"+"<td>"+e.role_prop.title+"</td>"+"<td>"+e.role_prop.location+"</td>"+"<td>"+e.role_prop.phone+"</td>"+"<td>"+e.role_prop.tel_phone+"</td>"+"<td>"+'<div role="group" class="btn-group btn-group-sm">'+'<button type="button" class="btn btn-default edit_btn">查看/编辑</button>'+'<button type="button" class="btn btn-success patient_btn">选择患者</button>'+'<button type="button" class="btn btn-danger del_user">删除</button>'+"</div>"+"</td>"+"</tr>";console.log(userList),console.log(b),userList.html(b)}).fail(function(a,b,c){console.log("textStatus:"+b),console.log("errorThrown:"+c)})}),userList.on("click",".del_user",function(a){var b,c;a.preventDefault(),window.confirm("确认要删除吗？")&&(b=$(this).closest("tr"),c=b.data("uid"),$.get("/del_user?uid="+c,function(a){console.log(a),b.remove()}))});