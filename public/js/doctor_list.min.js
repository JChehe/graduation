var addUserDialog=$("#add-user");var addUserForm=addUserDialog.find("form");var userTable=$("table");addUserDialog.find(":submit").click(function(a){a.preventDefault();$.ajax({url:addUserForm.attr("action"),type:addUserForm.attr("method"),data:addUserForm.serialize()}).done(function(c){if(c.status){var b=c.user;$("<tr data-uid="+b.uid+" data-role="+b.role+"><td>"+b.account+"</td><td>"+b.real_name+"</td><td data-sex="+b.sex+">"+(b.sex=="0"?"男":"女")+"</td><td>"+(b.age==undefined?"未填写":b.age)+"</td><td>"+b.title+"</td><td>"+b.location+"</td><td>"+b.phone+"</td><td>"+b.tel_phone+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success patient_btn">查看家属</button><button type="button" class="btn btn-danger del_user">删除</button></div></td></tr>').prependTo(userTable.find("tbody"));addUserDialog.modal("hide");addUserForm.trigger("reset")}else{alert(c.info)}}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});var editUserDialog=$("#edit-user");var curTr=null;userTable.find("tbody").on("click",".edit_btn",function(b){curTr=$(this).closest("tr");var a=curTr.find("td");editUserDialog.find("[name='account']").val(a.eq(0).text()).end().find("[name='real_name']").val(a.eq(1).text()).end().find("[name='sex']").each(function(){if($(this).val()==a.eq(2).data("sex")){$(this).attr("checked",true);return false}}).end().find("[name='title']").val(a.eq(4).text()).end().find("[name='location']").val(a.eq(5).text()).end().find("[name='tel_phone']").val(a.eq(7).text()).end().find("[name='phone']").val(a.eq(6).text()).end().find("[name=edit_user_id]").val(curTr.data("uid"));editUserDialog.modal("show")});var editUserDialog=$("#edit-user");var editUserForm=editUserDialog.find("form");editUserDialog.find(":submit").click(function(a){a.preventDefault();$.ajax({url:editUserForm.attr("action")+"/"+curTr.data("uid"),type:editUserForm.attr("method"),data:editUserForm.serialize()}).done(function(c){alert(c.info);if(c.status){var b=c.user;curTr.find("td").eq(1).text(b.real_name).end().eq(2).text(b.sex==0?"男":"女").end().eq(3).text(b.age).end().eq(4).text(b.title).end().eq(5).text(b.location).end().eq(6).text(b.phone).end().eq(6).text(b.tel_phone);editUserDialog.modal("hide");editUserForm.trigger("reset")}else{}}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});var patientDialog=$("#patient-list");var patientTbody=patientDialog.find("table tbody");userTable.find("tbody").on("click",".patient_btn",function(b){b.preventDefault();curTr=$(this).closest("tr");var a=curTr.data("patientList");$("[name='doctor_id']").val(curTr.data("uid"));$("[name='origin_patient_list']").val(a);$.ajax({url:"/get_patient_list",type:"get"}).done(function(h){patientTbody.empty();var d=h.patientList;for(var g=0,c=d.length;g<c;g++){var f=d[g];var e=f.role_prop;var j=false;if(a!=null){j=curTr.data("patientList").indexOf(f._id)>-1}$('<tr><td><input type="checkbox" name="care_patient_id" value="'+f._id+'" '+(j?"checked":"")+"></td><td>"+f.account+"</td><td>"+e.real_name+"</td><td>"+(e.sex=="0"?"男":"女")+"</td><td>"+e.age+"</td><td>"+e.address+"</td><td>"+e.tel_phone+"</td><td>"+e.phone+"</td></tr>").appendTo(patientTbody)}});patientDialog.modal("show")});var searchForm=$("#search-form");var userList=$("#userlist").find("tbody");searchForm.submit(function(a){a.preventDefault();$.ajax({url:$(this).attr("action"),type:$(this).attr("method"),data:$(this).serialize()}).done(function(e){console.log(e);userList.empty();var f="";for(var d=0,b=e.userList.length;d<b;d++){var c=e.userList[d];f+=('<tr data-uid="'+c._id+'" data-role="2" data-patient-list="'+c.care_patient+'"><td>'+c.account+"</td><td>"+c.role_prop.real_name+'</td><td data-sex="'+c.role_prop.sex+'">'+(c.role_prop.sex=="0"?"男":"女")+"</td><td>"+c.role_prop.age+"</td><td>"+c.role_prop.title+"</td><td>"+c.role_prop.location+"</td><td>"+c.role_prop.phone+"</td><td>"+c.role_prop.tel_phone+'</td><td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-success patient_btn">选择患者</button><button type="button" class="btn btn-danger del_user">删除</button></div></td></tr>')}console.log(userList);console.log(f);userList.html(f)}).fail(function(b,d,c){console.log("textStatus:"+d);console.log("errorThrown:"+c)})});userList.on("click",".del_user",function(b){b.preventDefault();if(window.confirm("确认要删除吗？")){var c=$(this).closest("tr");var a=c.data("uid");$.get("/del_user?uid="+a,function(d){console.log(d);c.remove()})}});
