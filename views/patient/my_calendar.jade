extends ../layout

block exclusiveStyle
	//- link(rel="stylesheet" href="js/libs/cupertino/jquery-ui.min.css")
	link(rel="stylesheet" href="css/libs/fullcalender/fullcalendar.css")
	link(rel="stylesheet" href="css/libs/fullcalender/fullcalendar.print.css" media='print')
	style.
		.level0{
			border-color: #d9534f;
			background-color: #d9534f;
		}
		.level1{
			border-color: #f0ad4e;
			background-color: #f0ad4e;
		}
		.level2{
			border-color: #5bc0de;
			background-color: #5bc0de;
		}
		.level3{
			border-color: #5cb85c;
			background-color: #5cb85c;
		}
		.level4{
			border-color: #337ab7;
			background-color: #337ab7;
		}

block content
	h3.page-header 你所在的路径：信息系统 / 我的日历视图
	div#calendar
	
	div(class="modal fade" id="view-diagnose")
		div(class="modal-dialog")
			div(class="modal-content")
				div(class="modal-header")
					button(type="button" class="close" data-dismiss="modal" aria-label="Close")
						span &times;
					h4 查看相关诊断信息
				div(class="modal-body")
					table.table.table-striped
						thead
							tr
								th 诊断时间
								th 医生
								th 内容
						tbody.diagnose-tbody

				div(class="modal-footer")
					button(type="button" class="btn btn-default" data-dismiss="modal") 关闭
					button(type="submit" class="btn btn-primary") 确定

block exclusiveScript
	script(src="js/libs/moment.min.js")
	script(src="js/libs/jquery-ui.custom.min.js")
	script(src="js/libs/fullcalendar.min.js")
	script(src="js/libs/zh-cn.js")
	script.
		window.onload = function(){
			$.get("/get_calendar_events", function(data){
				console.log(data)
				var events = [];
				console.log(data.eventList)
				$.each(data.eventList, function(index){
					if(!isNaN(+index)){

						events[index] = {
							title: this.name,
							start: this.happen_time,
							end: this.end_time,
							className: "level" + this.level,
							url: "get_related_diagnose?eid=" + this._id
						}
					}
				})
				console.log(events)
				$('#calendar').fullCalendar({
				    header: {
						left: 'prev,next today',
						center: 'title',
						right: 'month,agendaWeek,agendaDay'
					},
					defaultDate: data.today,
					buttonIcons: false, // show the prev/next text
					weekNumbers: true,
					editable: true,
					eventLimit: true, // allow "more" link when too many events
					events: events,
					eventClick: function(calEvent, jsEvent, view){
						event.preventDefault();
						$.get(calEvent.url, function(data){
							console.log(data);
							var diaStr = "";

							for(var i = 0, len = data.length; i < len; i++){
								var cData = data[i];

								diaStr += '<tr>' +
							        '<td>'+ cData.create_time +'</td>' +
							        '<td>'+ cData.doctor_name +'</td>' +
							        '<td>'+ cData.content +'</td>' +
							    '</tr>';
							}
							$(".diagnose-tbody").html(diaStr);
							$("#view-diagnose").modal('toggle')
						})
					}
				});
			})
		}

		

		var viewDiagnoseDialog = $("#view-diagnose");
		