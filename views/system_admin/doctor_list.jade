extends ../layout

block exclusiveStyle
	//- link(rel="stylesheet" href="css/index.css")
	


block content
	h3.page-header 你所在的路径：信息系统 / 医生用户列表
	
	include ../includes/userSearchForm
	
	button(type="button" class="btn btn-default" data-toggle="modal" data-target="#add-user") 添加新系统用户
	table.table.table-striped
		thead 
			tr 
				td 账户名
				td 姓名
				td 性别
				td 年龄
				td 职位
				td 办公室
				td 电话
				td 手机
				td 操作
		tbody
			each value, index in userList
				-var roleProp = value.role_prop
				tr(data-uid="#{value._id}" data-role="#{value.role}" data-patient-list="#{value.care_patient}")
					td= value.account
					td= roleProp.real_name
					td(data-sex="#{roleProp.sex}")= roleProp.sex == 0? "男": "女"
					td= roleProp.age
					td= roleProp.title
					td= roleProp.location
					td= roleProp.phone
					td= roleProp.tel_phone
					td 
						div.btn-group.btn-group-sm(role="group")
							button.btn.btn-default(type="button" class="edit_btn") 查看/编辑
							button.btn.btn-default(type="button" class="patient_btn") 选择患者
							button.btn.btn-default(type="button") 删除
							
	include ../includes/pagination

	div(class="modal fade" id="patient-list")
		div(class="modal-dialog modal-lg")
			div(class="modal-content")
				form.form-horizontal(action="/add_care_patient" method="post")
					input(type="hidden" name="doctor_id" value="")
					input(type="hidden" name="origin_patient_list" value="")
					div(class="modal-header")
						button(type="button" class="close" data-dismiss="modal" aria-label="Close")
							span &times;
						h4 选择患者用户
					div(class="modal-body")
						table.table
							thead
								tr
									th 选择
									th 账户名
									th 姓名
									th 性别
									th 年龄
									th 地址
									th 电话
									th 手机
							tbody
					div.modal-footer
						button(type="button" class="btn btn-default" id="close-family-form-btn").pull-right 关闭
						button(type="submit" style="margin-right:10px").btn.btn-primary.pull-right 确定添加

	


	div(class="modal fade" id="add-user")
		div(class="modal-dialog")
			div(class="modal-content")
				form.form-horizontal(action="/add_doctor_user" method="post")
					div(class="modal-header")
						button(type="button" class="close" data-dismiss="modal" aria-label="Close")
							span &times;
						h4 添加医生用户
					div(class="modal-body")
							input(type="hidden" name="role" value="1")
							div.form-group
								label(class="col-sm-3 control-label text-left") 账户名：
								div.col-sm-9
									input(type="text" class="form-control" placeholder="请输入您的用户名" name="account")
							div.form-group
								label(for="" class="col-sm-3 control-label text-left") 姓名：
								div.col-sm-9
									input( type="text" class="form-control" placeholder="请输入您的真实姓名" name="real_name")
							div.form-group
								label(class="col-sm-3 control-label text-left") 性别：
								div.col-sm-9
									label(class="radio-inline")
										input(type="radio" name="sex" value="0") 
										| 男
									label(class="radio-inline")
										input(type="radio" name="sex" value="1") 
										| 女
							div.form-group
								label(for="" class="col-sm-3 control-label text-left") 密码：
								div.col-sm-9
									input(type="password" class="form-control" name="password")
										
							div.form-group
								label(for="" class="col-sm-3 control-label text-left") 确认密码：
								div.col-sm-9
									input(type="password" class="form-control")
							div.form-group
								label(class="col-sm-3 control-label text-left") 电话号码：
								div.col-sm-9
									input(type="text" class="form-control" name="phone")
							div.form-group
								label(class="col-sm-3 control-label text-left") 手机号码：
								div.col-sm-9
									input(type="text" class="form-control" name="tel_phone")
							div.form-group
								label(class="col-sm-3 control-label text-left") 科室：
								div.col-sm-9
									input(type="text" class="form-control" name="location")
							div.form-group
								label(class="col-sm-3 control-label text-left") 职位：
								div.col-sm-9
									input(type="text" class="form-control" name="title")
					div.modal-footer
						button(type="button" class="btn btn-default" id="close-family-form-btn" data-dismiss="modal").pull-right 关闭
						button(type="submit" style="margin-right:10px").btn.btn-primary.pull-right 确定添加
	div(class="modal fade" id="edit-user")
		div(class="modal-dialog")
			div(class="modal-content")
				form.form-horizontal(action="/edit_doctor_user" method="post")
					div(class="modal-header")
						button(type="button" class="close" data-dismiss="modal" aria-label="Close")
							span &times;
						h4 编辑医生用户
					div(class="modal-body")
							input(type="hidden" name="role" value="2")
							input(type="hidden" name="edit_user_id" value="")
							div.form-group
								label(class="col-sm-3 control-label text-left") 账户名：
								div.col-sm-9
									input(type="text" class="form-control" placeholder="请输入您的用户名" name="account" disabled)
							div.form-group
								label(for="" class="col-sm-3 control-label text-left") 姓名：
								div.col-sm-9
									input( type="text" class="form-control" placeholder="请输入您的真实姓名" name="real_name")
							div.form-group
								label(class="col-sm-3 control-label text-left") 性别：
								div.col-sm-9
									label(class="radio-inline")
										input(type="radio" name="sex" value="0") 
										| 男
									label(class="radio-inline")
										input(type="radio" name="sex" value="1") 
										| 女
							div.form-group
								label(class="col-sm-3 control-label text-left") 电话号码：
								div.col-sm-9
									input(type="text" class="form-control" name="phone")
							div.form-group
								label(class="col-sm-3 control-label text-left") 手机号码：
								div.col-sm-9
									input(type="text" class="form-control" name="tel_phone")
							div.form-group
								label(class="col-sm-3 control-label text-left") 科室：
								div.col-sm-9
									input(type="text" class="form-control" name="location")
							div.form-group
								label(class="col-sm-3 control-label text-left") 职位：
								div.col-sm-9
									input(type="text" class="form-control" name="title")
					div.modal-footer
						button(type="button" class="btn btn-default" id="close-family-form-btn" data-dismiss="modal").pull-right 关闭
						button(type="submit" style="margin-right:10px").btn.btn-primary.pull-right 确定添加
						
block exclusiveScript
	script.
		// 添加医生用户
		var addUserDialog = $("#add-user")
		var addUserForm = addUserDialog.find("form")
		var userTable = $("table")
		addUserDialog.find(":submit").click(function(event){
			event.preventDefault();
			$.ajax({
				url: addUserForm.attr("action"),
				type: addUserForm.attr("method"),
				data: addUserForm.serialize()
			}).done(function(data){

				if(data.status){
					var user = data.user;
					$('<tr data-uid='+ user.uid +' data-role='+ user.role +'>' +
						'<td>'+user.account+'</td>' +
						'<td>'+user.real_name+'</td>' +
						'<td data-sex='+ user.sex +'>'+(user.sex == "0" ? "男": "女")+'</td>' +
						'<td>'+ (user.age == undefined? "未填写": user.age) +'</td>' +
						'<td>'+ user.title +'</td>' +
						'<td>'+ user.location +'</td>' +
						'<td>'+ user.phone +'</td>' +
						'<td>'+ user.tel_phone +'</td>' +
						'<td><div role="group" class="btn-group btn-group-sm"><button type="button" class="btn btn-default edit_btn">查看/编辑</button><button type="button" class="btn btn-default patient_btn">查看家属</button><button type="button" class="btn btn-default">删除</button></div></td>'+
					'</tr>').prependTo(userTable.find("tbody"));
					
					addUserDialog.modal('hide')
					addUserForm.trigger("reset")
				}else{
					alert(data.info)
				}
				
			}).fail(function(jqXHR, textStatus, errorThrown ){
				console.log("textStatus:" + textStatus)
				console.log("errorThrown:" + errorThrown)
			})
		})


		// 点击表格行时，设置表单的默认信息
		var editUserDialog = $('#edit-user');
		var curTr = null;
		userTable.find("tbody").on("click", ".edit_btn", function(event){
			curTr = $(this).closest("tr")
			var curAllTd = curTr.find("td")
			editUserDialog.find("[name='account']").val(curAllTd.eq(0).text()).end()
				.find("[name='real_name']").val(curAllTd.eq(1).text()).end()
				.find("[name='sex']").each(function(){
					if($(this).val() == curAllTd.eq(2).data("sex")){
						$(this).attr("checked", true)
						return false;
					}
				}).end()
				.find("[name='title']").val(curAllTd.eq(4).text()).end()
				.find("[name='location']").val(curAllTd.eq(5).text()).end()
				.find("[name='tel_phone']").val(curAllTd.eq(7).text()).end()
				.find("[name='phone']").val(curAllTd.eq(6).text()).end()
				.find("[name=edit_user_id]").val(curTr.data("uid"))

			editUserDialog.modal('show')
		})

		// 编辑系统用户表单处理
		var editUserDialog = $("#edit-user");
		var editUserForm = editUserDialog.find("form")
		editUserDialog.find(":submit").click(function(event){
			event.preventDefault()
			$.ajax({
				url: editUserForm.attr("action") + "/" + curTr.data("uid"),
				type: editUserForm.attr("method"),
				data: editUserForm.serialize()
			}).done(function(data){
				alert(data.info);

				if(data.status){
					var user = data.user;
					curTr.find("td").eq(1).text(user.real_name).end()
						.eq(2).text(user.sex == 0? "男":"女").end()
						.eq(3).text(user.age).end()
						.eq(4).text(user.title).end()
						.eq(5).text(user.location).end()
						.eq(6).text(user.phone).end()
						.eq(6).text(user.tel_phone);
					
					
					
					editUserDialog.modal('hide')
					editUserForm.trigger("reset")
				}else{
					//- alert(data.info)
				}
				
			}).fail(function(jqXHR, textStatus, errorThrown ){
				console.log("textStatus:" + textStatus)
				console.log("errorThrown:" + errorThrown)
			})
		})
		




		var patientDialog = $("#patient-list")
		var patientTbody = patientDialog.find("table tbody")
		userTable.find("tbody").on("click", ".patient_btn", function(event){
			event.preventDefault();
			curTr = $(this).closest("tr")
			var curSelectedPatient = curTr.data("patientList")
			$("[name='doctor_id']").val(curTr.data("uid"))
			$("[name='origin_patient_list']").val(curSelectedPatient)
			$.ajax({
				url: "/get_patient_list",
				type: "get"
			}).done(function(data){
				patientTbody.empty()
				
				var patientList = data.patientList;
				for(var i = 0, iL = patientList.length; i < iL; i++){
					var curPatient = patientList[i];
					var curRoleProp = curPatient.role_prop;
					var isChecked = false;
					if(curSelectedPatient != null){
						isChecked = curTr.data("patientList").indexOf(curPatient._id) > -1;
					}

					$('<tr>' +
						'<td>' +
							'<input type="checkbox" name="care_patient_id" value="'+curPatient._id+'" '+ (isChecked?"checked" : "") +'>' +
						'</td>' +
						'<td>'+curPatient.account+'</td>' +
						'<td>'+curRoleProp.real_name+'</td>' +
						'<td>'+(curRoleProp.sex == "0"?"男":"女") +'</td>' +
						'<td>'+curRoleProp.age+'</td>' +
						'<td>'+curRoleProp.address+'</td>' +
						'<td>'+curRoleProp.tel_phone+'</td>' +
						'<td>'+curRoleProp.phone+'</td>' +
					'</tr>').appendTo(patientTbody)
				}
			})




			patientDialog.modal('show')
		})

		var searchForm = $("#search-form");
		var userList = $("#userlist").find("tbody");
		searchForm.submit(function(event){
			event.preventDefault();
			$.ajax({
				url: $(this).attr("action"),
				type: $(this).attr("method"),
				data: $(this).serialize()
			}).done(function(data){
				console.log(data);
				userList.empty();

				for(var i = 0, iL = data.userList.length; i < iL; i++){
					var cData = data.userList[i];
					$('<tr data-uid="'+ cData._id +'" data-role="2" data-patient-list="'+ cData.care_patient +'">' +
		        '<td>'+ cData.account +'</td>' +
		        '<td>'+ cData.role_prop.real_name+'</td>' +
		        '<td data-sex="'+ cData.role_prop.sex +'">'+ cData.role_prop.sex?"男":"女" +'</td>' +
		        '<td>'+ cData.role_prop.age +'</td>' +
		        '<td>'+ cData. +'</td>' +
		        '<td>6E-206</td>' +
		        '<td>22222333</td>' +
		        '<td>33333333333</td>' +
		        '<td>' +
		            '<div role="group" class="btn-group btn-group-sm">' +
		                '<button type="button" class="btn btn-default edit_btn">查看/编辑</button>' +
		                '<button type="button" class="btn btn-default patient_btn">选择患者</button>' +
		                '<button type="button" class="btn btn-default">删除</button>' +
		            '</div>' +
		        '</td>' +
		    '</tr>').appendTo(userList)
				}

			}).fail(function(jqXHR, textStatus, errorThrown ){
				console.log("textStatus:" + textStatus)
				console.log("errorThrown:" + errorThrown)
			})
		})